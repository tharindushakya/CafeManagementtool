# Security Analysis — 001-description-baseline-specification

This document outlines the security and compliance requirements for the Gaming Café Management baseline feature. It captures mTLS topology, RBAC recommendations, Stripe/PCI gating, and required CI gating for production secrets.

## mTLS for device RPCs
- Requirement: All device RPCs (gRPC) must require mutual TLS in production. This prevents rogue devices from impersonating kiosks or consoles.
- Dev/test: Use self-signed dev certs generated by `infra/certs/generate-dev-certs.ps1` (or shell script) and configure API gateway to accept these in non-prod environments.
- Production: Use CA-signed certs managed by infra (Vault/Key Vault) with automated rotation.

## RBAC and least-privilege
- Roles: admin, manager, operator, support, player. Define policies in `backend/src/auth/rbac/policies.yaml`.
- Enforcement: API gateway should perform initial policy check; services must verify for any sensitive operation (payments, refunds, admin user changes).

## Stripe & PCI considerations
- Stripe test-mode may be used during development, but production Stripe secrets must not be added to the codebase.
- CI gating: Require Security Owner sign-off before any PR that exposes Stripe production secrets or enables production mode.
- Webhook handling: Verify Stripe webhook signatures using the webhook signing secret and ensure idempotent processing.

## Data retention & encryption
- Payments/receipts must be stored only as required; card data MUST never be stored. If using Stripe, store only Stripe IDs and reconciliation metadata.
- At-rest encryption: Use DB-level encryption for sensitive columns if required by compliance.

## Audit logging
- Payment-related actions, admin role changes, and webhook reconcile events must be logged to an append-only audit store. Consider a dedicated `audit_logs` table or external service.

## CI gating and approvals
- Add a CI check that blocks merging PRs that: `enable production Stripe keys`, `add infra cert changes`, or `modify RBAC policies` until a Security Owner reviews.

## Next steps
1. Add `infra/certs/generate-dev-certs.ps1` to produce dev certificates and README.
2. Add `backend/src/auth/rbac/policies.yaml` and enforcement middleware.
3. Implement webhook signature verification in `payments` service.
4. Add CI workflow to require Security Owner approval before enabling Stripe production keys.
